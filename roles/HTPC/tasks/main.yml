- name: Install needed packages
  become: yes
  apt:
    pkg: "{{ item }}"
    state: present
    force: yes
  with_items:
    - lvm2
    - openssh-server
    - rsync
    - htop
    - mc
    - nano

- name: Mount data volume
  become: yes
  mount:
    path: "{{ data_directory }}"
    src: "{{ data_volume }}"
    fstype: ext4
    opts: defaults,relatime,nofail
    state: mounted

- name: Mount shared directory as home
  become: yes
  mount:
    path: /home/shared
    src: "{{ shared_directory }}"
    fstype: none
    opts: bind,nofail
    state: mounted

- name: Authorize public key
  authorized_key:
    user: "{{ user }}"
    key: "{{ lookup('file', 'files/' + item + '.pub') }}"
  with_items:
    - OTG@KeePass
    - petr@PK-HP450G3
    - root@PK-HP450G3
    - windows@PK-HP450G3
    - windows@R2200G
    - pi@raspberry-pi-zero-1
    - pi@raspberry-pi-zero-2

- name: Disallow password authentication
  become: yes
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    state: present
  notify: Restart ssh

- name: Assign Emby Web Client to standard HTTP port
  become: yes
  iptables:
    table: nat
    chain: "{{ item }}"
    protocol: tcp
    match: tcp
    destination: "{{ local_ip }}"
    destination_port: 80
    jump: REDIRECT
    to_ports: 8096
    comment: Assign Emby Web App to standard HTTP port
  with_items:
    - PREROUTING
    - OUTPUT

- name: Assign Emby Web Client to standard HTTPS port
  become: yes
  iptables:
    table: nat
    chain: "{{ item }}"
    protocol: tcp
    match: tcp
    destination: "{{ local_ip }}"
    destination_port: 443
    jump: REDIRECT
    to_ports: 8920
    comment: Assign Emby Web Client to standard HTTPS port
  with_items:
    - PREROUTING
    - OUTPUT

- name: "Add links to media directories to users desktop"
  become: yes
  file:
    src: "{{ shared_directory }}/{{ item }}"
    dest: "/home/{{ user }}/Desktop/{{ item }}"
    state: link
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0400
    force: yes
  with_items: "{{ media_directories }}"
