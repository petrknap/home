- name: Install needed packages
  become: yes
  apt:
    pkg: "{{ item }}"
    state: present
    force: yes
  with_items:
    - openssh-server
    - rsync
    - htop
    - mc
    - nano

- name: Authorize public key
  authorized_key:
    user: "{{ user }}"
    key: "{{ lookup('file', 'files/' + item + '.pub') }}"
  with_items:
    - OTG@KeePass
    - petr@PK-HP450G3
    - root@PK-HP450G3
    - windows@PK-HP450G3
    - windows@R2200G
    - pi@raspberry-pi-zero-1
    - pi@raspberry-pi-zero-2

- name: Disallow password authentication
  become: yes
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    state: present
  notify: Restart ssh

- name: Assign Emby Web Client to standard HTTP port
  become: yes
  iptables:
    table: nat
    chain: "{{ item }}"
    protocol: tcp
    match: tcp
    destination: "192.168.0.253"
    destination_port: 80
    jump: REDIRECT
    to_ports: 8096
    comment: Assign Emby Web App to standard HTTP port
  with_items:
    - PREROUTING
    - OUTPUT

- name: Assign Emby Web Client to standard HTTPS port
  become: yes
  iptables:
    table: nat
    chain: "{{ item }}"
    protocol: tcp
    match: tcp
    destination: "192.168.0.253"
    destination_port: 443
    jump: REDIRECT
    to_ports: 8920
    comment: Assign Emby Web Client to standard HTTPS port
  with_items:
    - PREROUTING
    - OUTPUT

- name: "Add links to media directories to users desktop"
  become: no
  file:
    src: "/home/shared/{{ item }}"
    dest: "{{ home_dir }}/Desktop/{{ item }}"
    state: link
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0400
  with_items: "{{ emby_media_dirs }}"

- name: Backup /
  become: yes
  cron:
    name: "Backup '/'"
    hour: 17
    minute: 0
    job: "/bin/bash -c \"'/home/{{ user }}/backup'\""

- name: Find rtcwake
  become: yes
  command: which rtcwake
  register: which_rtcwake

- name: Suspend & wake up
  become: yes
  cron:
    name: "Suspend & wake up (weekday: {{ item.d }})"
    weekday: "{{ item.d }}"
    hour: "{{ item.h }}"
    minute: "{{ item.m }}"
    job: "{{ which_rtcwake.stdout }} -m off -s {{ (item.t * 3600)|int }}"
  with_items:
    - {d: 1, h: 0, m: 45, t: 10.75}
    - {d: 2, h: 0, m: 45, t: 10.75}
    - {d: 3, h: 0, m: 45, t: 10.75}
    - {d: 4, h: 0, m: 45, t: 10.75}
    - {d: 5, h: 0, m: 45, t: 10.75}
