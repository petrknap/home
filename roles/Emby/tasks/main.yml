- set_fact:
    emby:
      data_directory: /var/lib/emby
      new_data_directory: "{{ data_directory}}/emby"
      create_p12: "openssl pkcs12 -export -inkey /etc/letsencrypt/live/{{ domain }}/privkey.pem -in /etc/letsencrypt/live/{{ domain }}/cert.pem -out {{ emby.new_data_directory }}/{{ domain}}.p12 -passout pass: && chown emby:emby {{ emby.new_data_directory }}/{{ domain}}.p12"

- name: "Check if server is installed"
  command: dpkg-query -W emby-server
  register: dpkg_emby
  failed_when: dpkg_emby.rc > 1
  changed_when: dpkg_emby.rc == 1

- name: "Download server"
  get_url:
    url: "https://github.com/MediaBrowser/Emby.Releases/releases/download/{{ version }}/emby-server-deb_{{ version }}_{{ architecture }}.deb"
    dest: /tmp/emby-server.deb
  when: dpkg_emby.rc == 1

- name: "Install server"
  become: true
  apt:
    deb: /tmp/emby-server.deb
  when: dpkg_emby.rc == 1

- name: "Enable server"
  become: yes
  systemd:
    name: emby-server
    enabled: yes

- name: "Create shared directory"
  become: yes
  file:
    path: "{{ shared_directory }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: 0777

- name: "Create new data directory"
  become: yes
  file:
    path: "{{ emby.new_data_directory }}"
    state: directory
    owner: emby
    group: emby
    mode: 0700

- name: Remove old data directory
  become: yes
  file:
    path: "{{ emby.data_directory }}"
    state: absent

- name: Link new data directory
  become: yes
  file:
    src: "{{ emby.new_data_directory }}"
    dest: "{{ emby.data_directory }}"
    state: link
    owner: emby
    group: emby
    mode: 0400

- name: "Create media directories"
  become: yes
  file:
    path: "{{ shared_directory }}/{{ item }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: 0777
  with_items: "{{ media_directories }}"

- name: "Prevent media directories deletion"
  become: yes
  file:
    path: "{{ shared_directory }}/{{ item }}/.keep"
    state: touch
    owner: nobody
    group: nogroup
    mode: 0000
  with_items: "{{ media_directories }}"

- name: Grant permissions to emby
  become: yes
  cron:
    name: "Grant permissions to emby on '{{ shared_directory }}/{{ item }}/'"
    special_time: hourly
    job: "chgrp --recursive emby '{{ shared_directory }}/{{ item }}/' && chmod --recursive g-x+rwX '{{ shared_directory }}/{{ item }}/'"
  with_items: "{{ media_directories }}"

- name: "Generate PKCS#12 version of certificate for {{ domain }}"
  become: yes
  command: "{{ emby.create_p12 }}"

- name: "Regenerate PKCS#12 version of certificate for {{ domain }}"
  become: yes
  cron:
    name: "Regenerate PKCS#12 version of certificate for {{ domain }}"
    hour: 0
    minute: 0
    day: 1
    job: "{{ emby.create_p12 }} && service emby-server restart"

- name: "Start server"
  become: yes
  systemd:
    name: emby-server
    state: started
