- name: Install needed packages
  become: yes
  apt:
    pkg:
      - docker.io
    state: present
    force: yes

- name: "Create configuration directories"
  become: yes
  file:
    path: "{{ item }}"
    state: directory
    mode: 0777
    recurse: yes
  with_items:
    - "{{ configuration_directory }}/etc/pihole"
    - "{{ configuration_directory }}/etc/dnsmasq.d"

- name: Start DNS server
  become: yes
  docker_container:
    name: Pi-hole
    image: pihole/pihole
    state: started
    restart: yes
    restart_policy: always
    volumes:
      - "{{ configuration_directory }}/etc/pihole/:/etc/pihole/"
      - "{{ configuration_directory }}/etc/dnsmasq.d/:/etc/dnsmasq.d/"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8053:80/tcp"
    env:
      WEBPASSWORD: "{{ lookup('password', configuration_directory + '/admin.password length=8') }}"
