#!/bin/bash

###################################################################################################
#   Macros                                                                                        #
###################################################################################################

vagrant() {
    if [ "$1" == "up" ]
    then
        command vagrant "up"
        command vagrant "ssh"
    elif [ "$1" == "reboot" ]
    then
        vagrant "halt"
        vagrant "up"
    else
        command vagrant "$@"
    fi
}



git() {
    if [ "$1" == "help" ] && [ "$2" == "" ]
    then
        command git "$@"
        command echo ""
        command echo "Macro extension:"
        command echo "   git mpull [<directory>]"
        command echo "      Pulls all git repositories in directory and subdirectories."
    elif [ "$1" == "mpull" ] && [ "$2" != "" ]
    then
    (
        command cd "$2"
        git "mpull"
    )
    elif [ "$1" == "mpull" ]
    then
        if [ -d "./.git" ]
        then
            command echo "Opening $PWD"
            command git pull --ff-only
        fi
        for D in `find . -maxdepth 1 -type d`
        do
        (
            if [ "$D" != "." ]
            then
                command cd "$D"
                git "mpull"
            fi
        )
        done
    else
        command git "$@"
    fi
}



phpunit() {
    command echo "Opening $PWD"
    if [ -e "phpunit.xml" ]
    then
    (
        command phpunit "$@"
    )
    elif [ -d "./module" ]
    then
    (
        command cd "./module"
        for D in `find . -maxdepth 1 -type d`
        do
        (
            command cd "$D"
            phpunit "$@"
        )
        done
    )
    else
        if [ -d "./test" ]
        then
        (
            command cd "./test"
            phpunit "$@"
        )
        elif [ -d "./tests" ]
        then
        (
             command cd "./tests"
             phpunit "$@"
        )
        else
             command phpunit "$@"
        fi
    fi
}



composer() {
    if [ "$1" == "help" ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]
    then
        command composer "$@"
        command echo ""
        command echo "Macro extension:"
        command echo "   composer rollback"
        command echo "      Rollbacks last update and restores previous state."
    elif [ "$1" == "update" ]
    then
        command cat "./composer.lock" > "./.composer.lock"
        command composer "$@"
    elif [ "$1" == "rollback" ]
    then
        if [ -e "./.composer.lock" ]
        then
            command cat "./.composer.lock" > "./composer.lock"
            command rm "./.composer.lock"
            command composer "install"
        else
            command echo "ERROR!"
            command echo "    Backup of composer.lock not found."
        fi
    else
        command composer "$@"
    fi
}

###################################################################################################
