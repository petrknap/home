#!/usr/bin/env bash

REMOTE_SOURCE="${1}"
REMOTE_PORT="${2}"
TARGET="${3}"
EXCLUDES="${4}"
BANDWIDTH___KBps="${5}"

if [[ "${BANDWIDTH___KBps}" == "" ]]; then
    BANDWIDTH___KBps=1073741824
fi

LAST_SUCCESSFUL_DEST="${TARGET}/LAST"
LAST_DEST="${LAST_SUCCESSFUL_DEST}.tmp"
CURRENT_DIR="$(date +'%Y-%m-%d_%H-%M')"

if [[ ! -e "${LAST_SUCCESSFUL_DEST}" ]]; then
    ln -s "${TARGET}/${CURRENT_DIR}" "${LAST_SUCCESSFUL_DEST}"
fi

if [[ ! -e "${LAST_DEST}" ]]; then
    ln -s "${LAST_SUCCESSFUL_DEST}" "${LAST_DEST}"
fi

echo "${EXCLUDES}" > "${TARGET}/excludes.txt"

rsync --exclude-from="${TARGET}/excludes.txt" \
      --rsh="ssh -o ServerAliveInterval=60 -p ${REMOTE_PORT}" \
      --bwlimit="${BANDWIDTH___KBps}" \
      --archive \
      --human-readable \
      --progress \
      --compress \
      --link-dest="${LAST_SUCCESSFUL_DEST}" \
      --link-dest="${LAST_DEST}" \
      "${REMOTE_SOURCE}" "${TARGET}/${CURRENT_DIR}.tmp" > "${TARGET}/${CURRENT_DIR}.log" 2>&1 \
&& mv "${TARGET}/${CURRENT_DIR}.tmp" "${TARGET}/${CURRENT_DIR}" \
&& (
    rm "${LAST_SUCCESSFUL_DEST}";
    ln -s "${TARGET}/${CURRENT_DIR}" "${LAST_SUCCESSFUL_DEST}"
    rm "${LAST_DEST}";
) \
|| (
    rm "${LAST_DEST}";
    ln -s "${TARGET}/${CURRENT_DIR}.tmp" "${LAST_DEST}"
)
