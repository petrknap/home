#!/usr/bin/env bash

REMOTE_SOURCE="${1}"
REMOTE_PORT="${2}"
TARGET="${3}"
EXCLUDES="${4}"
ARGUMENTS="${5}"

LAST_SUCCESSFUL_DEST="${TARGET}/LAST"
LAST_DEST="${LAST_SUCCESSFUL_DEST}.tmp"

if [[ -e "${LAST_SUCCESSFUL_DEST}" ]]; then
    ARGUMENTS="--link-dest=\"${LAST_SUCCESSFUL_DEST}\" ${ARGUMENTS}"
fi

if [[ -e "${LAST_DEST}" ]]; then
    ARGUMENTS="--link-dest=\"${LAST_DEST}\" ${ARGUMENTS}"
fi

echo "${EXCLUDES}" > "${TARGET}/excludes.txt"

CURRENT_DIR="$(date +'%Y-%m-%d_%H-%M')"
RSYNC=" \
rsync --exclude-from=\"${TARGET}/excludes.txt\" \
      --rsh=\"ssh -o ServerAliveInterval=60 -p ${REMOTE_PORT}\" \
      --archive \
      --human-readable \
      --progress \
      --compress \
      ${ARGUMENTS} \
"

bash -c " \
${RSYNC} --existing \"${REMOTE_SOURCE}\" \"${TARGET}/${CURRENT_DIR}.tmp\" > \"${TARGET}/${CURRENT_DIR}.log\" 2>&1 \
&& ${RSYNC} --ignore-existing \"${REMOTE_SOURCE}\" \"${TARGET}/${CURRENT_DIR}.tmp\" >> \"${TARGET}/${CURRENT_DIR}.log\" 2>&1 \
&& mv \"${TARGET}/${CURRENT_DIR}.tmp\" \"${TARGET}/${CURRENT_DIR}\" \
&& ( \
    rm \"${LAST_SUCCESSFUL_DEST}\"; \
    ln -s \"${TARGET}/${CURRENT_DIR}\" \"${LAST_SUCCESSFUL_DEST}\"; \
    rm \"${LAST_DEST}\"; \
) \
|| ( \
    rm "${LAST_DEST}"; \
    ln -s "${TARGET}/${CURRENT_DIR}.tmp" "${LAST_DEST}"; \
) \
"
