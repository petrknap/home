#!/usr/bin/env bash

REMOTE_SOURCE=$1
REMOTE_PORT=$2
TARGET=$3
EXCLUDES=$4
BANDWIDTH___KBps=$5

if [[ "${BANDWIDTH___KBps}" == "" ]]; then
    BANDWIDTH___KBps=1073741824
fi

echo "${EXCLUDES}" > "${TARGET}/excludes.txt"

CURRENT_DIR=$(date +'%Y-%m-%d_%H-%M')
rsync --exclude-from="${TARGET}/excludes.txt" \
      --rsh="ssh -o ServerAliveInterval=60 -p ${REMOTE_PORT}" \
      --bwlimit="${BANDWIDTH___KBps}" \
      --archive \
      --human-readable \
      --progress \
      --compress \
      --checksum \
      --link-dest="${TARGET}/LAST" \
      --link-dest="${TARGET}/LAST.tmp" \
      "${REMOTE_SOURCE}" "${TARGET}/${CURRENT_DIR}.tmp" > "${TARGET}/${CURRENT_DIR}.log" 2>&1 \
&& mv "${TARGET}/${CURRENT_DIR}.tmp" "${TARGET}/${CURRENT_DIR}" \
&& (
    rm "${TARGET}/LAST";
    ln -s "${TARGET}/${CURRENT_DIR}" "${TARGET}/LAST"
    rm "${TARGET}/LAST.tmp";
) \
|| (
    rm "${TARGET}/LAST.tmp";
    ln -s "${TARGET}/${CURRENT_DIR}.tmp" "${TARGET}/LAST.tmp"
)
