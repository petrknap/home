#!/usr/bin/env bash

REMOTE_SOURCE="${1}"
REMOTE_PORT="${2}"
TARGET="${3}"
EXCLUDES="${4}"
ARGUMENTS="${5}"

LAST_SUCCESSFUL_DEST="${TARGET}/LAST"
LAST_DEST="${LAST_SUCCESSFUL_DEST}.tmp"
CURRENT_DIR="$(date +'%Y-%m-%d_%H-%M')"
FINAL_DIR="${TARGET}/${CURRENT_DIR}"
WORKING_DIR="${FINAL_DIR}.tmp"
LOG_FILE="${FINAL_DIR}.log"
EXCLUDE_LIST="${TARGET}/excludes.txt"
RSYNC=" \
rsync --exclude-from=\"${EXCLUDE_LIST}\" \
      --rsh=\"ssh -o ServerAliveInterval=60 -p ${REMOTE_PORT}\" \
      --archive \
      --human-readable \
      --progress \
      --compress \
      ${ARGUMENTS} \
"

echo "${EXCLUDES}" > "${EXCLUDE_LIST}"

if [[ -e "${LAST_SUCCESSFUL_DEST}" ]]; then (
    echo "Linking files from last successful backup..." >> "${LOG_FILE}"
    bash -c "${RSYNC} --link-dest=\"${LAST_SUCCESSFUL_DEST}/\" \"${LAST_SUCCESSFUL_DEST}/\" \"${WORKING_DIR}\" >> \"${LOG_FILE}\" 2>&1"
); fi

if [[ -e "${LAST_DEST}" ]]; then (
    echo "Linking files from last backup..." >> "${LOG_FILE}"
    bash -c "${RSYNC} --link-dest=\"${LAST_DEST}/\" \"${LAST_DEST}/\" \"${WORKING_DIR}\" >> \"${LOG_FILE}\" 2>&1"
); fi

bash -c " \
   echo \"Checking existing files...\" >> \"${LOG_FILE}\" \
&& ${RSYNC} --existing \"${REMOTE_SOURCE}\" \"${WORKING_DIR}\" >> \"${LOG_FILE}\" 2>&1 \
&& echo \"Downloading new files...\" >> \"${LOG_FILE}\" \
&& ${RSYNC} --ignore-existing \"${REMOTE_SOURCE}\" \"${WORKING_DIR}\" >> \"${LOG_FILE}\" 2>&1 \
&& echo \"Removing deleted files...\" >> \"${LOG_FILE}\" \
&& ${RSYNC} --delete \"${REMOTE_SOURCE}\" \"${WORKING_DIR}\" >> \"${LOG_FILE}\" 2>&1 \
&& mv \"${WORKING_DIR}\" \"${FINAL_DIR}\" \
&& ( \
    rm \"${LAST_SUCCESSFUL_DEST}\"; \
    ln -s \"${FINAL_DIR}\" \"${LAST_SUCCESSFUL_DEST}\"; \
    rm \"${LAST_DEST}\"; \
) \
|| ( \
    rm "${LAST_DEST}"; \
    ln -s "${WORKING_DIR}" "${LAST_DEST}"; \
) \
"
